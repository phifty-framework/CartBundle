{% extends '@CRUD/edit.html' %}
{% block section_body %}

<form class="ajax-action" enctype="multipart/form-data" method="post">
    {{ CRUD.Action.renderSignatureWidget|raw}}
    {% if CRUD.Record.id %}
        {{ forms.hidden('id', CRUD.Record.id) }}
    {% endif %}

    <div class="row">

        <div class="col-md-3">
            <fieldset>
                <legend>訂單</legend>
                {{ CRUD.Action.renderField('sn')|raw }}
                {{ CRUD.Action.renderField('token')|raw }}
            </fieldset>

            <fieldset>
                <legend>付款</legend>

                {{ CRUD.Action.renderField('payment_type')|raw }}
                {{ CRUD.Action.renderField('payment_status')|raw }}

                <div class="clearfix">
                    <div class="col-field">
                        {{ CRUD.Action.renderField('total_amount')|raw }}
                    </div>
                    <div class="col-field">
                    {{ CRUD.Action.renderField('paid_amount')|raw }}
                    </div>
                </div>

                <div class="clearfix">
                    <div class="col-field">
                        {{ CRUD.Action.renderField('shipping_cost')|raw }}
                    </div>
                    <div class="col-field">
                        {{ CRUD.Action.renderField('discount_amount')|raw }}
                    </div>
                </div>
            </fieldset>
        </div>

        {% for prefix, label in {
            'buyer_': '購買人',
            'shipping_': '收貨人'
        } %}
        <div class="col-md-3">
            <fieldset>
                <legend>{{label}}</legend>

                <div class="col-field">
                {{ CRUD.Action.renderField(prefix ~ 'name')|raw }}
                </div>
                <div class="col-field">
                {{ CRUD.Action.renderField(prefix ~ 'gender')|raw }}
                </div>
                <div class="clearfix"> </div>

                {{ CRUD.Action.renderField(prefix ~ 'cellphone')|raw }}

                <div class="v-field">
                <div class="label">
                    聯絡電話
                </div>
                <div class="input">
                    {{ CRUD.Action.renderWidget( prefix ~ 'phone_area')|raw }}
                    - {{ CRUD.Action.renderWidget( prefix ~ 'phone')|raw }}
                    # {{ CRUD.Action.renderWidget( prefix ~ 'phone_ext')|raw }}
                </div>


                {{ CRUD.Action.renderField(prefix ~ 'address')|raw }}

            </div>
            </fieldset>
        </div>
        {% endfor %}



    </div>
    <div class="clearfix"> </div>

    <div class="row">
    </div>


    <div class="row">
        <div class="col-md-11">
            <h3>訂單明細</h3>
            <div class="collapsible collapse-section" {# data-collapse="persist" #}>
                <h3>交易記錄</h3>
                <div>
                    <table width="100%">
                    <thead>
                        <th>編號</th>
                        <th>類型</th>
                        <th>金額</th>
                        <th>訊息</th>
                        <th>原因</th>
                        <th>付款日期</th>
                    </thead>
                    <tbody>
                    {% for txn in CRUD.Record.transactions %}
                    <tr class="{% if txn.result %}success{% else %}fail{% endif %}">
                        <td>{{txn.id}}</td>
                        <td>{{txn.display('type')}}</td>
                        <td>{{txn.amount}}</td>
                        <td>{{txn.message}}</td>
                        <td>{{txn.reason}}</td>
                        <td>{{txn.paid_date}}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    </table>
                </div>
                <h3>購買項目</h3>
                <div>
                    {#
                        {% set subview = CRUD.Action.asView('ActionKit\\View\\StackView',{ "no_form": 1 }) %}
                        {{ subview.buildRelationalActionViewForExistingRecords('order_items') |raw }}
                    #}

                    <table width="100%">
                    <thead>
                        <th>產品</th>
                        <th>類型</th>
                        <th>單價</th>
                        <th>數量</th>
                        <th>小計</th>
                        <th>貨運狀態</th>
                        <th width="100">貨運公司</th>
                        <th width="100">貨運編號</th>
                    </thead>
                    <tbody>
                    {% for orderItem in CRUD.Record.order_items %}
                    {% set subRecordAction = orderItem.asUpdateAction() %}
                    {% set formIndex = subRecordAction.setParamNamesWithIndex('order_items') %}
                    <tr>
                        <td>
                            {{ subRecordAction.renderSignatureWidget()| raw }}
                            {{ subRecordAction.renderWidget('id')| raw }}
                            {{ subRecordAction.renderWidget('product_id')| raw }}
                        </td>
                        <td>
                            {{subRecordAction.renderWidget('type_id')|raw}}
                        </td>
                        <td>{{orderItem.getUnitPrice()}}</td>
                        <td>{{subRecordAction.renderWidget('quantity')|raw}}</td>
                        <td>{{orderItem.calculateAmount()}}</td>
                        <td>{{subRecordAction.renderWidget('shipping_status')|raw}}</td>
                        <td>{{subRecordAction.renderWidget('shipping_company_id')|raw}}</td>
                        <td>{{subRecordAction.renderWidget('shipping_id')|raw}}</td>
                        <td>
                            {% set trackingUrl = orderItem.getTrackingUrl() %}
                            {% if trackingUrl %}
                                <a target="_blank" href="{{trackingUrl}}">追蹤</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% include '@CRUD/controll.html' %}
</form>

{% endblock %}
